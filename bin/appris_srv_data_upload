#!/bin/bash

# -----------------------------------------------------------------------------
# Load environmental variables
# If you do not trust the path, configure below:
SYSTEM=`uname -s`
if [ "$SYSTEM" = Darwin ]
then
	source /etc/bashrc
	source /etc/profile
	source ${HOME}/.bash_profile
elif [ "$SYSTEM" = Linux ]
then
	source /etc/profile
	source /etc/bash.bashrc
	source ${HOME}/.bashrc
fi

# -----------------------------------------------------------------------------
# Load external functions
DIRNAME=`dirname $0`
source ${DIRNAME}/appris_env

SRV_NAME="appris@appris"
SRV_RELEASEDIR="/local/appris/pub/releases"
RELEASE=""
VLISTS=""

# -----------------------------------------------------------------------------
# Usage

USAGE="
\n
 APPRIS's binary package.\n
\n
 Name:\n
\t appris_srv_data_upload\n
\n
 Description:\n
\t Upload the datafiles into server.\n
\n
 Required arguments:\n
\t -c [-conf] {file}\n
\t\t Bash file with config variables\n
\n
\t -h [-help]\n
\n
\n
 Author: Jose Manuel Rodriguez Carrasco -jmrodriguez@cnio.es- (INB-GN2,CNIO)\n
\n
"
# -----------------------------------------------------------------------------
# Get input parameters

while expr "//$1" : //- >/dev/null
do
	case "$1" in
		-c | -conf )
			CONFIG=$2
			shift
			;;
		-h | -help )
			echo -e $USAGE		
			exit
			;;
		* )
			echo Unknown option: "$1"
			echo -e $USAGE
			exit 1
			;;
	esac
	shift
done

if [ "${CONFIG}" == "" ]; then
	echo You must specify the config file
	echo -e $USAGE
	exit 1
fi

# -----------------------------------------------------------------------------
# Local methods

run() {
	echo $1
	eval $1
}


# -----------------------------------------------------------------------------
# Read variables from config file
source "${CONFIG}"

## 
echo "# locale in annotation dir:"
run "cd ${APPRIS_ANNOT_DIR}"

##
echo "# create link from assembly version to data version:"
for ALINK in "${LINKS_VDATA_TO_ASSEMBLIES[@]}" ; do
	run "cd ${APPRIS_ANNOT_DIR} && ${ALINK}"
done

##
echo "# upload datafiles:"
TARFILES_ASS=""
TARFILES_DAT=""
for FILE in "${VASSEMBLIES[@]}" ; do
	TARFILES_ASS+="${FILE} "
done
for FILE in "${VDATAFILES[@]}" ; do
	TARFILES_DAT+="${FILE} "
done
if [[ ("${TARFILES_ASS}" == "") || ("${TARFILES_DAT}" == "") ]]; then
	echo Empty list of versions
	exit 1
fi
run "cd ${APPRIS_ANNOT_DIR} && tar -cf - ${TARFILES_ASS} ${TARFILES_DAT} | ssh ${SRV_NAME} 'mkdir -p ${SRV_DATADIR}; cd ${SRV_DATADIR}/; tar -xf -'"
